#!/bin/bash

# To use, add 'alias ghd=". ghd"' to your ~/.bashrc, and put ghd in your PATH.
#
# Switches to the given github url/repo.
# Clones to GHD_LOCATION, or /tmp/ghd if not set.
# Clones via https by default (set GHD_USE_SSH=1 for ssh).

function _ghd_run() {
  location_root="${GHD_LOCATION:-/tmp/ghd}"
  use_ssh="${GHD_USE_SSH:-0}"
  pager="${PAGER:-cat}"
  repo_url_or_name="$1"
  is_pull_requested=0
  if [[ $repo_url_or_name == *"!" ]]; then
    repo_url_or_name="${repo_url_or_name::-1}"
    is_pull_requested=1
  fi
  GITHUB_PREFIX='^\(\(https:\/\/\)\|\(git@\)\)github\.com[:/]'
  GITHUB_SUFFIX='\.git$'

  function maybe_pull() { # location_root repo_url target
    location_root="$1"
    repo_url="$2"
    target="$3"
    directory="$location_root/$target"

    if [[ $is_pull_requested -eq 0 ]] && [[ -d "$directory" ]]; then
      return 0
    fi

    if [[ -z "$location_root" ]]; then
      return 1
    fi

    if [[ "$target" == '/' ]] || [[ "$target" != *"/"* ]]; then
      return 0
    fi

    if [[ ! -d "$directory" ]]; then
      git clone -- "$repo_url" "$directory"
      return $? # return the result of the clone.
    fi

    if [[ -d "$directory/.git" ]]; then
      git -C "$directory" pull --all
      return 0
    fi

    return 0
  }

  function get_repo_name() { # repo_url_or_name
    repo_url_or_name="$1"
    name="$(echo "$repo_url_or_name" | \
      sed -e "s/$GITHUB_PREFIX//g" | \
      sed -e "s/$GITHUB_SUFFIX//g")"
    echo "$name"
  }

  function get_repo_url() { # repo_url_or_name
    repo_url_or_name="$1"
    if [[ $repo_url_or_name =~ ^$GITHUB_PREFIX ]]; then
      echo "$repo_url_or_name"
    elif [[ $use_ssh -eq 1 ]]; then
      echo "git@github.com:$repo_url_or_name"
    else
      echo "https://github.com/$repo_url_or_name"
    fi
  }

  function search_local() { # name
    name="$1"

    find $location_root -maxdepth 2 -name "*$name*" -printf "%P\n"
  }

  function search_gh() { # name
    name="$1"

    if ! command -v gh > /dev/null 2>&1; then
      return 1
    fi

    if ! gh auth status > /dev/null 2>&1; then
      return 2
    fi

    repos="$(gh repo list --limit 10000 | cut -f1)"

    if [[ -z "$name" ]]; then
      echo "$repos"
    fi

    echo "$repos" | grep "$name"
  }

  function get_repo_list() { # name
    name="$1"
    {
      search_local "$name"
      search_gh "$name"
    } | \
      awk 'NF' | \
      sort -u
  }

  function fzf_ghd() { # query matches -> choice
    query="$1"
    matches="$2"

    if [[ -z "$matches" ]]; then
      return 1
    fi

    if ! declare -F __fzfcmd >/dev/null; then
      return 2
    fi

    dest="$(echo "$matches" | \
      $(__fzfcmd) --query="$query" --preview="
        printf 'https://www.github.com/{}\n\n' &&
        $pager '$location_root/{}/README.md'" \
    )"
    fzf_status="$?"
    if [[ "$fzf_status" -ne 0 ]]; then
      return "$fzf_status";
    fi
    echo "$dest"
    return 0
  }

  function handle_single_name() { # name
    single_name="$1"
    matches="$(get_repo_list "$single_name")"
    if [[ -z $matches ]]; then
      if fzf_ghd "$single_name" "$matches"; then
        return 0
      fi
      echo "No cloned repository, user, or organization found for: $single_name" >&2
      return 1
    fi

    num_matches="$(echo "$matches" | wc -l)"
    if [ "$num_matches" -eq 1 ]; then
      echo "$matches"
      return 0
    fi

    if fzf_ghd "$single_name" "$matches"; then
      return 0
    fi

    echo "Found multiple matches for $single_name:" >&2
    echo "$matches" >&2
    return 1
  }

  function find_target() { # repo_name
    repo_name="$1"

    if [[ -z "$repo_name" ]]; then
      fzf_ghd '' "$(get_repo_list)"
      return $?
    fi

    if [[ "$repo_name" == "/" ]]; then
      return 0
    fi

    if [[ "$repo_name" == *"/"* ]]; then
      echo "$repo_name"
      return 0
    fi

    handle_single_name $repo_name
    return $?
  }

  mkdir -p "$location_root"

  repo_name="$(get_repo_name "$repo_url_or_name")"
  target="$(find_target "$repo_name")"
  result=$?
  if [[ $result -ne 0 ]]; then
    return $result
  fi
  repo_url="$(get_repo_url "$target")"

  maybe_pull "$location_root" "$repo_url" "$target"
  result=$?
  if [[ $result -ne 0 ]]; then
    return $result
  fi
  cd "$location_root/$target"
  return 0
}

_ghd_run $@
